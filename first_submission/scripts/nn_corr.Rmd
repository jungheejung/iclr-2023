---
title: "iclr_corr"
author: "Heejung Jung"
date: '2022-09-14'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

"""
This notebook examines whether the correlation coefficients between two metrics 
are statistically significant or not. 

* linear model of correlation coefficient (different from 0), modeling random intercepts for class and layer
* I use fisher z to transform these correlation coefficients into Z vlaues (normal distribution)
* From that, we get the t-estimate, testing whether this is significant
* Afterward, I plan to convert the B0 estimate back into an r value, which is interpretable. 

"""
# load data
# calculate correlation
# fisher z transform 
# model mean cor value for class layer unit

```{r load libraries include=FALSE}
library(psych)
library(car)
#library(lmSupport)
library(lme4)
library(lmerTest)
library(plyr)
library(dplyr)
library(correlation)
library(ggplot2)
library(rmarkdown)
library(readr)
library(yaml)
library(tidyverse)
library(GGally)
library(DescTools)
source('http://psych.colorado.edu/~jclab/R/mcSummaryLm.R')
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/R_rainclouds.R")
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/summarySE.R")
source("/Users/h/Documents/projects_local/RainCloudPlots/tutorial_R/simulateData.R")
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
file.sources = list.files(c("/Users/h/Dropbox/projects_dropbox/social_influence_analysis/scripts/step02_R/utils"),
                          pattern="*.R", 
                          full.names=TRUE, 
                          ignore.case=TRUE)
sapply(file.sources,source,.GlobalEnv)

```

# Main statistical test Question 01 :: Is this correlation significantly different from the null, i.e. 0? 
Using the fisher z transfor, we test whether tthe correlation coefficients are significantly different from 0, while modeling random intercepts in class and layers (allowing for class and layers to have different "mean" coefficients).
```{r}
main_dir <- dirname(getwd())
for (model in c('alexnet', 'mobilenet')) {
  analysis_dir <- file.path(main_dir, 'results', model, as.character(Sys.Date()))
  dir.create(analysis_dir, showWarnings = FALSE, recursive = TRUE)
  statsummary_fname <- file.path(
            analysis_dir,
            paste('statsummary_model-', model,
                '_', as.character(Sys.Date()), '.txt',
                sep = ""
            )
        )
  if (file.exists(statsummary_fname)) {
      file.remove(statsummary_fname)
  }

  statsummary <- ""
  for (dv in c('ablation_impact_X_cka', 
               'ablation_impact_X_decoding_accuracy_delta',
               'ablation_impact_X_mean_cca_corr', 
               'ablation_impact_X_mean_sq_cca_corr',
               'ablation_impact_X_procrustes', 
               'ablation_impact_X_pwcca',
               'decoding_accuracy_delta_X_cka',
               'decoding_accuracy_delta_X_mean_cca_corr',
               'decoding_accuracy_delta_X_mean_sq_cca_corr',
               'decoding_accuracy_delta_X_procrustes', 
               'decoding_accuracy_delta_X_pwcca')) {
    # load data per metric
    if (model == "alexnet") {
      data_fname <- file.path(main_dir, 'data', model, paste0(dv, '.csv'))
    } else if (model == "mobilenet") {
      data_fname <- file.path(main_dir, 'data', model, paste0(dv, '-mobilenet.csv'))
      }
  
    df <- read.csv(data_fname)
    df$fisherZ <- DescTools::FisherZ(df$correlation)
    model_cor <- lmer(fisherZ ~ 1 + (1|class) + (1|layer) , data = df)
    model_savefname <- file.path(
            analysis_dir,
            paste('lmer_model-', model,
                '_dv-', dv,
                '_', as.character(Sys.Date()), '.txt',
                sep = ""
            )
        )
  if (file.exists(model_savefname)) {
      file.remove(model_savefname)
  }
    sink(file = model_savefname)
    s <- summary(model_cor)
    capture.output(s, file = model_savefname)
    stats <- paste0('b = ',round(summary(model_cor)$coefficients[1], digits = 3), ', ',
          't(', round(summary(model_cor)$coefficients[3], digits = 2), ') = ',
          round(summary(model_cor)$coefficients[4], digits = 3),', ',
          'p = ',round(summary(model_cor)$coefficients[5],digits = 4))
    print(stats)
    sink(file = NULL)
    
    statsummary <- paste0(statsummary, '\n', '* metric: ', dv, '  >>>   stats: ', stats, '\n')
  }
  sink(file = statsummary_fname)
  # print(cat(statsummary))
  capture.output(cat(statsummary), file = statsummary_fname)
  sink(file = NULL)


}
```

# filename
# ablation_impact X cka

```{r load data}

data_fname = file.path(main_dir, 'data', model, paste0('ablation_impact_X_cka', '.csv'))
alexnet = read.csv(data_fname)
```
arise(cor = cor(decoding_accuracy_delta,ablation_impact))

```{r fisher z transform}
# fisher z transform
alexnet$fisherZ = DescTools::FisherZ(alexnet$correlation)

```


```{r}
model_cor = lmer(fisherZ ~ 1 + (1|class) + (1|layer) , data = alexnet)
model_savefname <- file.path(
        analysis_dir,
        paste('lmer_model-', model,
            '_dv-', dv,
            '_', as.character(Sys.Date()), '.txt',
            sep = ""
        )
    )
sink(file = model_savefname)
summary(model_cor)
paste0('b = ',round(summary(model_cor)$coefficients[1], digits = 3), ', ',
      't(', round(summary(model_cor)$coefficients[3], digits = 2), ') = ',
      round(summary(model_cor)$coefficients[4], digits = 3),', ',
      'p = ',round(summary(model_cor)$coefficients[5],digits = 4))
sink(file = NULL)

```


# covert estimate fisherz to r
```{r}
FisherZInv(0.19015)

```



